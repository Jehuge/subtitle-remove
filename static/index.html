<!doctype html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8"/>
  <title>AI å›¾ç‰‡å»æ°´å° Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <style>
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }
    @keyframes slideIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    .loading-spinner {
      width: 20px;
      height: 20px;
      border: 2px solid rgba(56, 189, 248, 0.3);
      border-top-color: #38bdf8;
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }
    .progress-bar {
      width: 100%;
      height: 4px;
      background: rgba(148, 163, 184, 0.2);
      border-radius: 2px;
      overflow: hidden;
      margin-top: 8px;
      display: none;
    }
    .progress-bar.active {
      display: block;
      animation: slideIn 0.3s ease;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #38bdf8, #818cf8);
      width: 0%;
      transition: width 0.3s ease;
      box-shadow: 0 0 10px rgba(56, 189, 248, 0.5);
    }
    .box-number {
      position: absolute;
      top: -2px;
      left: -2px;
      background: #38bdf8;
      color: #0b1120;
      font-size: 10px;
      font-weight: 600;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(56, 189, 248, 0.4);
    }
    .box-selected {
      stroke-dasharray: 5, 5;
      animation: pulse 1.5s ease-in-out infinite;
    }
    .undo-redo-btns {
      display: flex;
      gap: 4px;
    }
    .undo-redo-btns button {
      padding: 6px 10px;
      font-size: 12px;
    }
    .zoom-controls {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    .zoom-btn {
      width: 32px;
      height: 32px;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 16px;
    }
    .zoom-level {
      font-size: 11px;
      color: var(--text-subtle);
      min-width: 50px;
      text-align: center;
    }
    .canvas-container {
      position: relative;
      overflow: auto;
      max-height: 600px;
      border-radius: 12px;
      background: #020617;
    }
    .canvas-container::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }
    .canvas-container::-webkit-scrollbar-track {
      background: rgba(15, 23, 42, 0.5);
      border-radius: 4px;
    }
    .canvas-container::-webkit-scrollbar-thumb {
      background: rgba(56, 189, 248, 0.3);
      border-radius: 4px;
    }
    .canvas-container::-webkit-scrollbar-thumb:hover {
      background: rgba(56, 189, 248, 0.5);
    }
    .result-controls {
      display: flex;
      gap: 8px;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .compare-toggle {
      display: flex;
      align-items: center;
      gap: 6px;
      padding: 6px 12px;
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 999px;
      font-size: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .compare-toggle:hover {
      border-color: rgba(56, 189, 248, 0.6);
      background: rgba(15, 23, 42, 0.95);
    }
    .compare-toggle input[type="checkbox"] {
      width: 16px;
      height: 16px;
      cursor: pointer;
    }
    .result-img-wrapper {
      position: relative;
    }
    .result-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.95);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      cursor: pointer;
      padding: 20px;
    }
    .result-overlay.active {
      display: flex;
      animation: fadeIn 0.3s ease;
    }
    .result-overlay img {
      max-width: 95vw;
      max-height: 95vh;
      width: auto;
      height: auto;
      border-radius: 8px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.8);
      object-fit: contain;
      cursor: default;
    }
    .result-overlay::before {
      content: 'ç‚¹å‡»æˆ–æŒ‰ ESC å…³é—­';
      position: absolute;
      top: 20px;
      left: 50%;
      transform: translateX(-50%);
      color: rgba(255, 255, 255, 0.7);
      font-size: 14px;
      padding: 8px 16px;
      background: rgba(0, 0, 0, 0.5);
      border-radius: 20px;
      pointer-events: none;
    }
    .keyboard-hint {
      font-size: 10px;
      color: var(--text-subtle);
      margin-top: 4px;
    }
    .keyboard-hint kbd {
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 4px;
      padding: 2px 6px;
      font-size: 10px;
      font-family: monospace;
      margin: 0 2px;
    }
    .toast {
      position: fixed;
      top: 20px;
      right: 20px;
      background: rgba(15, 23, 42, 0.98);
      border: 1px solid rgba(148, 163, 184, 0.4);
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5);
      z-index: 1000;
      display: none;
      align-items: center;
      gap: 10px;
      animation: slideIn 0.3s ease;
      max-width: 300px;
    }
    .toast.show {
      display: flex;
    }
    .toast.success {
      border-color: rgba(34, 197, 94, 0.5);
    }
    .toast.error {
      border-color: rgba(239, 68, 68, 0.5);
    }
    .toast-icon {
      font-size: 18px;
    }
    .stats-info {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-subtle);
    }
    .stat-item {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .stat-value {
      color: var(--text-main);
      font-weight: 500;
    }
    .drag-over {
      border-color: rgba(56, 189, 248, 0.9) !important;
      background: radial-gradient(circle at top left, rgba(56,189,248,0.3), transparent 55%),
                  rgba(15,23,42,0.95) !important;
      transform: scale(1.02);
    }
    .box-list {
      max-height: 120px;
      overflow-y: auto;
      margin-top: 8px;
      padding: 8px;
      background: rgba(15, 23, 42, 0.5);
      border-radius: 8px;
      display: none;
    }
    .box-list.has-boxes {
      display: block;
    }
    .box-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 6px 8px;
      margin-bottom: 4px;
      background: rgba(15, 23, 42, 0.7);
      border-radius: 6px;
      font-size: 11px;
      transition: background 0.2s ease;
    }
    .box-item:hover {
      background: rgba(15, 23, 42, 0.9);
    }
    .box-item-info {
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .box-item-delete {
      background: rgba(239, 68, 68, 0.2);
      border: 1px solid rgba(239, 68, 68, 0.4);
      color: #fca5a5;
      padding: 4px 8px;
      font-size: 10px;
      cursor: pointer;
      border-radius: 4px;
      transition: all 0.2s ease;
    }
    .box-item-delete:hover {
      background: rgba(239, 68, 68, 0.3);
      border-color: rgba(239, 68, 68, 0.6);
    }
    .empty-state {
      text-align: center;
      padding: 40px 20px;
      color: var(--text-subtle);
    }
    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 12px;
      opacity: 0.5;
    }
    .empty-state-text {
      font-size: 13px;
      line-height: 1.6;
    }
    :root {
      color-scheme: dark light;
      --bg: #050816;
      --bg-elevated: #0f172a;
      --accent: #38bdf8;
      --accent-soft: rgba(56, 189, 248, 0.15);
      --border-subtle: rgba(148, 163, 184, 0.3);
      --text-main: #e5e7eb;
      --text-subtle: #9ca3af;
      --danger: #f97373;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      background: radial-gradient(circle at top, #1e293b 0, #020617 45%, #000 100%);
      color: var(--text-main);
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: center;
      padding: 24px;
    }
    .card {
      width: 100%;
      max-width: 1100px;
      background: linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.95));
      border-radius: 24px;
      border: 1px solid rgba(148,163,184,0.25);
      box-shadow:
        0 40px 80px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.25),
        0 0 50px rgba(56,189,248,0.15);
      padding: 24px 24px 20px;
      backdrop-filter: blur(24px);
    }
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 18px;
      gap: 12px;
    }
    .title-block h1 {
      font-size: 22px;
      letter-spacing: 0.02em;
      margin: 0 0 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .title-chip {
      font-size: 11px;
      padding: 2px 8px;
      border-radius: 999px;
      background: linear-gradient(135deg, rgba(56,189,248,0.2), rgba(56,189,248,0.05));
      border: 1px solid rgba(56,189,248,0.4);
      color: #e0f2fe;
      text-transform: uppercase;
      letter-spacing: 0.08em;
    }
    .title-block p {
      margin: 0;
      color: var(--text-subtle);
      font-size: 13px;
    }
    .tag-row {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 8px;
    }
    .tag {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.35);
      color: var(--text-subtle);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }
    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: radial-gradient(circle, #22c55e 0, #22c55e 30%, transparent 70%);
      box-shadow: 0 0 0 3px rgba(34,197,94,0.2);
    }
    .badge {
      font-size: 11px;
      padding: 6px 10px;
      border-radius: 999px;
      background: rgba(22,163,74,0.12);
      border: 1px solid rgba(22,163,74,0.4);
      color: #bbf7d0;
      display: flex;
      align-items: center;
      gap: 6px;
      white-space: nowrap;
    }
    .badge span {
      font-size: 16px;
    }
    .main {
      display: grid;
      grid-template-columns: minmax(0, 1.05fr) minmax(0, 0.95fr);
      gap: 18px;
    }
    @media (max-width: 900px) {
      .main { grid-template-columns: minmax(0, 1fr); }
    }
    .panel {
      background: radial-gradient(circle at top left, rgba(56,189,248,0.18), transparent 55%),
                  linear-gradient(145deg, rgba(15,23,42,0.98), rgba(15,23,42,0.96));
      border-radius: 18px;
      border: 1px solid rgba(148,163,184,0.3);
      padding: 14px 14px 12px;
      position: relative;
      overflow: hidden;
    }
    .panel::before {
      content: "";
      position: absolute;
      inset: -1px;
      border-radius: inherit;
      pointer-events: none;
      background:
        radial-gradient(circle at top left, rgba(56,189,248,0.35), transparent 50%),
        radial-gradient(circle at bottom right, rgba(59,130,246,0.15), transparent 55%);
      mix-blend-mode: soft-light;
      opacity: 0.35;
    }
    .panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .panel-title {
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      color: #9ca3af;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .panel-title::before {
      content: "";
      width: 8px;
      height: 8px;
      border-radius: 4px;
      background: linear-gradient(135deg, #38bdf8, #818cf8);
      box-shadow: 0 0 0 4px rgba(56,189,248,0.25);
    }
    .hint {
      font-size: 11px;
      color: var(--text-subtle);
    }
    .upload-zone {
      position: relative;
      border-radius: 14px;
      border: 1px dashed rgba(148,163,184,0.6);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.12), transparent 55%),
                  rgba(15,23,42,0.85);
      padding: 16px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      text-align: center;
      cursor: pointer;
      transition: border-color 0.18s ease, background 0.18s ease, transform 0.12s ease;
    }
    .upload-zone:hover {
      border-color: rgba(56,189,248,0.8);
      background: radial-gradient(circle at top left, rgba(56,189,248,0.22), transparent 55%),
                  rgba(15,23,42,0.9);
      transform: translateY(-1px);
    }
    .upload-icon {
      width: 40px;
      height: 40px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #e0f2fe 0, #38bdf8 28%, #0ea5e9 45%, #0f172a 85%);
      box-shadow:
        0 0 0 4px rgba(56,189,248,0.3),
        0 18px 28px rgba(15,23,42,0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      color: #0b1120;
      font-size: 26px;
    }
    .upload-text-main {
      font-size: 14px;
      font-weight: 530;
    }
    .upload-text-sub {
      font-size: 12px;
      color: var(--text-subtle);
    }
    .file-input {
      position: absolute;
      inset: 0;
      opacity: 0;
      cursor: pointer;
    }
    .canvas-wrapper {
      margin-top: 12px;
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.55);
      background: #020617;
      position: relative;
    }
    canvas {
      display: block;
      width: 100%;
      height: auto;
    }
    .toolbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 10px;
      gap: 8px;
      flex-wrap: wrap;
      font-size: 11px;
      color: var(--text-subtle);
    }
    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    button {
      border-radius: 999px;
      border: 1px solid transparent;
      font-size: 13px;
      padding: 7px 14px;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      font-weight: 500;
      background: rgba(15,23,42,0.95);
      color: var(--text-main);
      transition: background 0.16s ease, transform 0.12s ease, box-shadow 0.16s ease, border-color 0.12s;
    }
    button.primary {
      background: radial-gradient(circle at 30% 0, #e0f2fe 0, #38bdf8 30%, #0ea5e9 55%, #1d4ed8 100%);
      color: #0b1120;
      border-color: rgba(56,189,248,0.4);
      box-shadow:
        0 16px 30px rgba(15,23,42,0.9),
        0 0 0 1px rgba(148,163,184,0.4),
        0 0 30px rgba(56,189,248,0.4);
    }
    button.primary:hover {
      transform: translateY(-0.5px);
      box-shadow:
        0 18px 34px rgba(15,23,42,0.96),
        0 0 0 1px rgba(148,163,184,0.55),
        0 0 42px rgba(56,189,248,0.7);
      filter: brightness(1.02);
    }
    button.secondary {
      border-color: rgba(148,163,184,0.6);
      background: rgba(15,23,42,0.9);
    }
    button.secondary:hover {
      border-color: rgba(148,163,184,0.9);
      background: rgba(15,23,42,0.96);
      box-shadow: 0 10px 24px rgba(15,23,42,0.9);
    }
    button.secondary[style*="border-color: rgba(239, 68, 68"]:hover {
      border-color: rgba(239, 68, 68, 0.7) !important;
      background: rgba(239, 68, 68, 0.15) !important;
      color: #fca5a5 !important;
    }
    button:disabled {
      opacity: 0.6;
      cursor: default;
      box-shadow: none;
      transform: none;
    }
    .status {
      min-height: 16px;
      font-size: 11px;
      color: var(--text-subtle);
    }
    .status.error {
      color: var(--danger);
    }
    .status.success {
      color: #4ade80;
    }
    .result-img-wrapper {
      border-radius: 12px;
      overflow: hidden;
      border: 1px solid rgba(148,163,184,0.55);
      background: #020617;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 140px;
    }
    .result-img-wrapper img {
      max-width: 100%;
      height: auto;
      display: block;
    }
    .result-placeholder {
      font-size: 12px;
      color: var(--text-subtle);
      text-align: center;
      padding: 20px;
    }
    .meta-row {
      margin-top: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 11px;
      color: var(--text-subtle);
      flex-wrap: wrap;
    }
    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 8px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      border: 1px solid rgba(148,163,184,0.4);
    }
  </style>
</head>
<body>
<div class="card">
  <div class="header">
    <div class="title-block">
      <h1>
        AI å›¾ç‰‡å»æ°´å°
        <span class="title-chip">LaMa Inpainting</span>
      </h1>
      <p>ä¸Šä¼ å›¾ç‰‡ â†’ æ¡†é€‰å›ºå®šæ°´å°åŒºåŸŸ â†’ AI è‡ªåŠ¨å¡«å……å»é™¤ â†’ é¢„è§ˆä¸ä¸‹è½½ã€‚</p>
      <div class="tag-row">
        <span class="tag"><span class="pill-dot"></span>åŸºäº big-lamaï¼Œé«˜è´¨é‡å›¾ç‰‡ä¿®å¤</span>
        <span class="tag">æ‰‹åŠ¨æ¡†é€‰ Â· ç²¾å‡†æ§åˆ¶å»é™¤åŒºåŸŸ</span>
      </div>
    </div>
    <div class="badge">
      <span>âœ¨</span>
      é«˜è´¨é‡å»æ°´å°
    </div>
  </div>

  <div class="main">
    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">æºå›¾ç‰‡ & æ¡†é€‰æ°´å°</div>
        <div class="hint">æ‹–æ‹½æˆ–ç‚¹å‡»ä¸Šä¼ ï¼ŒæŒ‰ä½é¼ æ ‡æ‹–åŠ¨æ¡†é€‰æ°´å°ï¼Œå¯å¤šé€‰</div>
      </div>

      <label class="upload-zone">
        <div class="upload-icon">â†‘</div>
        <div class="upload-text-main">ç‚¹å‡»æˆ–æ‹–å…¥å›¾ç‰‡æ–‡ä»¶</div>
        <div class="upload-text-sub">æ”¯æŒ JPG / PNGï¼Œåˆ†è¾¨ç‡è¶Šé«˜æ•ˆæœè¶Šå¥½</div>
        <input id="fileInput" class="file-input" type="file" accept="image/*">
      </label>

      <div class="canvas-wrapper" id="canvasWrapper" style="display:none;">
        <div class="canvas-container" id="canvasContainer">
          <canvas id="canvas"></canvas>
        </div>
      </div>

      <div class="toolbar">
        <div>
          <div>æç¤ºï¼šå¯æ‹–å¤šæ¬¡æ·»åŠ å¤šä¸ªçŸ©å½¢æ¡†ï¼Œå³é”®æˆ–åŒå‡»ç©ºç™½åŒºåŸŸå–æ¶ˆå½“å‰æ“ä½œã€‚</div>
          <div class="keyboard-hint">
            å¿«æ·é”®ï¼š<kbd>Ctrl+Z</kbd>æ’¤é”€ <kbd>Ctrl+Y</kbd>é‡åš <kbd>Delete</kbd>åˆ é™¤é€‰ä¸­
          </div>
        </div>
        <div class="btn-row">
          <div class="undo-redo-btns">
            <button id="undoBtn" class="secondary" type="button" title="æ’¤é”€ (Ctrl+Z)" disabled>â†¶ æ’¤é”€</button>
            <button id="redoBtn" class="secondary" type="button" title="é‡åš (Ctrl+Y)" disabled>â†· é‡åš</button>
          </div>
          <button id="clearBtn" class="secondary" type="button">æ¸…ç©ºæ‰€æœ‰æ¡†</button>
          <button id="clearImageBtn" class="secondary" type="button" style="border-color: rgba(239, 68, 68, 0.4); color: #fca5a5;" disabled>ğŸ—‘ï¸ æ¸…é™¤å›¾ç‰‡</button>
        </div>
      </div>

      <div class="zoom-controls">
        <button id="zoomOutBtn" class="secondary zoom-btn" type="button" title="ç¼©å°">âˆ’</button>
        <span class="zoom-level" id="zoomLevel">100%</span>
        <button id="zoomInBtn" class="secondary zoom-btn" type="button" title="æ”¾å¤§">+</button>
        <button id="zoomFitBtn" class="secondary" type="button" style="margin-left: 8px; padding: 6px 10px; font-size: 12px;">é€‚åº”çª—å£</button>
      </div>

      <div class="box-list" id="boxList"></div>

      <div class="stats-info">
        <div class="stat-item">
          <span>å›¾ç‰‡å°ºå¯¸ï¼š</span>
          <span class="stat-value" id="imageSize">-</span>
        </div>
        <div class="stat-item">
          <span>å·²é€‰åŒºåŸŸï¼š</span>
          <span class="stat-value" id="boxCount">0</span>
        </div>
        <div class="stat-item">
          <span>æ–‡ä»¶å¤§å°ï¼š</span>
          <span class="stat-value" id="fileSize">-</span>
        </div>
      </div>

      <div class="status" id="statusText"></div>
      <div class="progress-bar" id="progressBar">
        <div class="progress-fill" id="progressFill"></div>
      </div>
    </section>

    <section class="panel">
      <div class="panel-header">
        <div class="panel-title">AI å»æ°´å°ç»“æœ</div>
        <div class="hint">ç‚¹å‡»â€œå¼€å§‹å»æ°´å°â€ï¼Œç¨ç­‰å‡ ç§’é’ŸæŸ¥çœ‹æ•ˆæœ</div>
      </div>

      <div class="result-img-wrapper">
        <img id="resultImg" alt="" style="display:none;">
        <div class="result-placeholder" id="placeholder">
          <div class="empty-state">
            <div class="empty-state-icon">ğŸ–¼ï¸</div>
            <div class="empty-state-text">
              å»æ°´å°ç»“æœä¼šæ˜¾ç¤ºåœ¨è¿™é‡Œ<br>
              ä¸Šä¼ å›¾ç‰‡å¹¶æ¡†é€‰æ°´å°åï¼Œç‚¹å‡»æŒ‰é’®å¼€å§‹å¤„ç†
            </div>
          </div>
        </div>
        <div class="result-overlay" id="resultOverlay">
          <img id="overlayImg" alt="">
        </div>
      </div>

      <div class="result-controls">
        <label class="compare-toggle">
          <input type="checkbox" id="compareToggle">
          <span>å¯¹æ¯”åŸå›¾</span>
        </label>
        <button id="fullscreenBtn" class="secondary" type="button" style="padding: 6px 12px; font-size: 12px;" disabled>ğŸ” å…¨å±æŸ¥çœ‹</button>
      </div>

      <div class="meta-row">
        <div class="pill">
          å½“å‰çŠ¶æ€ï¼š
          <span id="statusBadge">å¾…ä¸Šä¼ å›¾ç‰‡</span>
        </div>
        <div class="btn-row">
          <button id="downloadBtn" class="secondary" type="button" disabled>ğŸ“¥ ä¸‹è½½ç»“æœ</button>
          <button id="runBtn" class="primary" type="button" disabled>
            <span id="runBtnText">ğŸš€ å¼€å§‹å»æ°´å°</span>
            <span id="runBtnSpinner" class="loading-spinner" style="display: none; margin-left: 8px;"></span>
          </button>
        </div>
      </div>
    </section>
  </div>
</div>

<script>
  const fileInput = document.getElementById('fileInput');
  const canvas = document.getElementById('canvas');
  const canvasWrapper = document.getElementById('canvasWrapper');
  const canvasContainer = document.getElementById('canvasContainer');
  const statusText = document.getElementById('statusText');
  const runBtn = document.getElementById('runBtn');
  const runBtnText = document.getElementById('runBtnText');
  const runBtnSpinner = document.getElementById('runBtnSpinner');
  const clearBtn = document.getElementById('clearBtn');
  const clearImageBtn = document.getElementById('clearImageBtn');
  const undoBtn = document.getElementById('undoBtn');
  const redoBtn = document.getElementById('redoBtn');
  const resultImg = document.getElementById('resultImg');
  const placeholder = document.getElementById('placeholder');
  const downloadBtn = document.getElementById('downloadBtn');
  const statusBadge = document.getElementById('statusBadge');
  const progressBar = document.getElementById('progressBar');
  const progressFill = document.getElementById('progressFill');
  const zoomInBtn = document.getElementById('zoomInBtn');
  const zoomOutBtn = document.getElementById('zoomOutBtn');
  const zoomFitBtn = document.getElementById('zoomFitBtn');
  const zoomLevel = document.getElementById('zoomLevel');
  const boxList = document.getElementById('boxList');
  const compareToggle = document.getElementById('compareToggle');
  const fullscreenBtn = document.getElementById('fullscreenBtn');
  const resultOverlay = document.getElementById('resultOverlay');
  const overlayImg = document.getElementById('overlayImg');
  const imageSize = document.getElementById('imageSize');
  const boxCount = document.getElementById('boxCount');
  const fileSize = document.getElementById('fileSize');

  let originalImage = null;   // åŸå§‹ Image å¯¹è±¡
  let imageBlob = null;       // åŸå§‹æ–‡ä»¶ blob
  let boxes = [];             // å¤šä¸ª [x1,y1,x2,y2]
  let history = [];           // å†å²è®°å½•
  let historyIndex = -1;     // å½“å‰å†å²ç´¢å¼•
  let isDrawing = false;
  let startX = 0, startY = 0;
  let tempBox = null;
  let selectedBoxIndex = -1;
  let zoom = 1.0;
  let originalCanvasWidth = 0;
  let originalCanvasHeight = 0;
  let resultImageUrl = null;  // ä¿å­˜ç»“æœå›¾ç‰‡URL

  const ctx = canvas.getContext('2d');

  // å·¥å…·å‡½æ•°
  function formatFileSize(bytes) {
    if (bytes === 0) return '0 B';
    const k = 1024;
    const sizes = ['B', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
  }

  function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `toast ${type}`;
    const icons = { success: 'âœ“', error: 'âœ•', info: 'â„¹' };
    toast.innerHTML = `
      <span class="toast-icon">${icons[type] || icons.info}</span>
      <span>${message}</span>
    `;
    document.body.appendChild(toast);
    toast.classList.add('show');
    setTimeout(() => {
      toast.classList.remove('show');
      setTimeout(() => toast.remove(), 300);
    }, 3000);
  }

  function saveHistory() {
    history = history.slice(0, historyIndex + 1);
    history.push(JSON.parse(JSON.stringify(boxes)));
    historyIndex = history.length - 1;
    if (history.length > 50) {
      history.shift();
      historyIndex--;
    }
    updateUndoRedoButtons();
  }

  function updateUndoRedoButtons() {
    undoBtn.disabled = historyIndex <= 0;
    redoBtn.disabled = historyIndex >= history.length - 1;
  }

  function undo() {
    if (historyIndex > 0) {
      historyIndex--;
      boxes = JSON.parse(JSON.stringify(history[historyIndex]));
      drawImageAndBoxes();
      updateBoxList();
      updateStats();
      showToast('å·²æ’¤é”€', 'success');
    }
  }

  function redo() {
    if (historyIndex < history.length - 1) {
      historyIndex++;
      boxes = JSON.parse(JSON.stringify(history[historyIndex]));
      drawImageAndBoxes();
      updateBoxList();
      updateStats();
      showToast('å·²é‡åš', 'success');
    }
  }

  function updateStats() {
    if (originalImage) {
      imageSize.textContent = `${originalImage.width} Ã— ${originalImage.height}`;
    }
    boxCount.textContent = boxes.length;
    if (imageBlob) {
      fileSize.textContent = formatFileSize(imageBlob.size);
    }
  }

  function updateBoxList() {
    if (boxes.length === 0) {
      boxList.classList.remove('has-boxes');
      boxList.innerHTML = '';
      return;
    }
    boxList.classList.add('has-boxes');
    boxList.innerHTML = boxes.map((box, index) => {
      const [x1, y1, x2, y2] = box;
      const w = Math.round(x2 - x1);
      const h = Math.round(y2 - y1);
      return `
        <div class="box-item" data-index="${index}">
          <div class="box-item-info">
            <span>åŒºåŸŸ ${index + 1}</span>
            <span style="color: var(--text-subtle);">${w} Ã— ${h}px</span>
          </div>
          <button class="box-item-delete" data-index="${index}">åˆ é™¤</button>
        </div>
      `;
    }).join('');
    
    boxList.querySelectorAll('.box-item-delete').forEach(btn => {
      btn.addEventListener('click', (e) => {
        e.stopPropagation();
        const index = parseInt(btn.dataset.index);
        boxes.splice(index, 1);
        saveHistory();
        drawImageAndBoxes();
        updateBoxList();
        updateStats();
        showToast('å·²åˆ é™¤åŒºåŸŸ', 'success');
      });
    });

    boxList.querySelectorAll('.box-item').forEach(item => {
      item.addEventListener('click', () => {
        const index = parseInt(item.dataset.index);
        selectedBoxIndex = index;
        drawImageAndBoxes();
      });
    });
  }

  function setZoom(newZoom) {
    zoom = Math.max(0.25, Math.min(3, newZoom));
    zoomLevel.textContent = Math.round(zoom * 100) + '%';
    updateCanvasDisplay();
  }

  function updateCanvasDisplay() {
    if (!originalImage) return;
    const containerWidth = canvasContainer.clientWidth;
    const displayWidth = originalCanvasWidth * zoom;
    const displayHeight = originalCanvasHeight * zoom;
    
    canvas.style.width = displayWidth + 'px';
    canvas.style.height = displayHeight + 'px';
  }

  function zoomIn() {
    setZoom(zoom * 1.2);
  }

  function zoomOut() {
    setZoom(zoom / 1.2);
  }

  function zoomToFit() {
    if (!originalImage) return;
    // ç­‰å¾…å®¹å™¨å°ºå¯¸ç¡®å®šï¼Œä½¿ç”¨requestAnimationFrameç¡®ä¿DOMå·²æ¸²æŸ“
    requestAnimationFrame(() => {
      setTimeout(() => {
        const containerWidth = canvasContainer.clientWidth - 20;
        const containerHeight = canvasContainer.clientHeight - 20;
        if (containerWidth > 0 && containerHeight > 0 && originalCanvasWidth > 0 && originalCanvasHeight > 0) {
          const scaleX = containerWidth / originalCanvasWidth;
          const scaleY = containerHeight / originalCanvasHeight;
          setZoom(Math.min(scaleX, scaleY, 1));
        }
      }, 50);
    });
  }

  // çª—å£å¤§å°æ”¹å˜æ—¶ï¼Œå¦‚æœå›¾ç‰‡å·²åŠ è½½ï¼Œé‡æ–°é€‚åº”çª—å£
  let resizeTimer = null;
  window.addEventListener('resize', () => {
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => {
      if (originalImage && zoom < 1.1) {
        // åªæœ‰åœ¨æ¥è¿‘é€‚åº”çª—å£çš„ç¼©æ”¾çº§åˆ«æ—¶æ‰è‡ªåŠ¨è°ƒæ•´
        zoomToFit();
      }
    }, 200);
  });

  function setStatus(msg, type = '') {
    statusText.textContent = msg || '';
    statusText.className = 'status' + (type ? ' ' + type : '');
  }

  function setBadge(text) {
    statusBadge.textContent = text;
  }

  function resetResult() {
    resultImg.style.display = 'none';
    resultImg.src = '';
    placeholder.style.display = 'block';
    downloadBtn.disabled = true;
    fullscreenBtn.disabled = true;
    if (resultImageUrl) {
      URL.revokeObjectURL(resultImageUrl);
      resultImageUrl = null;
    }
    overlayImg.src = '';
    compareToggle.checked = false;
  }

  function clearAll() {
    // æ¸…é™¤å›¾ç‰‡å’Œæ‰€æœ‰çŠ¶æ€
    originalImage = null;
    imageBlob = null;
    boxes = [];
    history = [];
    historyIndex = -1;
    tempBox = null;
    selectedBoxIndex = -1;
    zoom = 1.0;
    originalCanvasWidth = 0;
    originalCanvasHeight = 0;
    
    // æ¸…é™¤æ–‡ä»¶è¾“å…¥
    fileInput.value = '';
    
    // éšè—canvas
    canvasWrapper.style.display = 'none';
    
    // é‡ç½®ç»“æœ
    resetResult();
    
    // é‡ç½®æŒ‰é’®çŠ¶æ€
    runBtn.disabled = true;
    clearBtn.disabled = true;
    clearImageBtn.disabled = true;
    undoBtn.disabled = true;
    redoBtn.disabled = true;
    
    // é‡ç½®ç»Ÿè®¡ä¿¡æ¯
    imageSize.textContent = '-';
    boxCount.textContent = '0';
    fileSize.textContent = '-';
    zoomLevel.textContent = '100%';
    
    // æ¸…é™¤åŒºåŸŸåˆ—è¡¨
    updateBoxList();
    
    // é‡ç½®çŠ¶æ€
    setStatus('', '');
    setBadge('å¾…ä¸Šä¼ å›¾ç‰‡');
    
    showToast('å·²æ¸…é™¤æ‰€æœ‰å†…å®¹', 'success');
  }

  function drawImageAndBoxes() {
    if (!originalImage) return;
    canvas.width = originalImage.width;
    canvas.height = originalImage.height;
    originalCanvasWidth = originalImage.width;
    originalCanvasHeight = originalImage.height;
    
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.drawImage(originalImage, 0, 0);

    // ç”»å·²ç»ç¡®è®¤çš„çŸ©å½¢
    ctx.lineWidth = 2;
    boxes.forEach((b, index) => {
      const isSelected = index === selectedBoxIndex;
      ctx.strokeStyle = isSelected ? 'rgba(34, 197, 94, 0.95)' : 'rgba(56, 189, 248, 0.95)';
      ctx.fillStyle = isSelected ? 'rgba(34, 197, 94, 0.2)' : 'rgba(56, 189, 248, 0.16)';
      const [x1, y1, x2, y2] = b;
      const w = x2 - x1;
      const h = y2 - y1;
      ctx.fillRect(x1, y1, w, h);
      ctx.strokeRect(x1 + 0.5, y1 + 0.5, w, h);
      
      // ç»˜åˆ¶ç¼–å·
      ctx.fillStyle = isSelected ? '#22c55e' : '#38bdf8';
      ctx.beginPath();
      ctx.arc(x1 + 9, y1 + 9, 9, 0, Math.PI * 2);
      ctx.fill();
      ctx.fillStyle = '#0b1120';
      ctx.font = 'bold 10px sans-serif';
      ctx.textAlign = 'center';
      ctx.textBaseline = 'middle';
      ctx.fillText((index + 1).toString(), x1 + 9, y1 + 9);
    });

    // å½“å‰æ­£åœ¨æ‹–æ‹½çš„çŸ©å½¢
    if (tempBox) {
      ctx.strokeStyle = 'rgba(248, 250, 252, 0.95)';
      ctx.fillStyle = 'rgba(248, 250, 252, 0.12)';
      const [x1, y1, x2, y2] = tempBox;
      const w = x2 - x1;
      const h = y2 - y1;
      ctx.fillRect(x1, y1, w, h);
      ctx.strokeRect(x1 + 0.5, y1 + 0.5, w, h);
    }
    
    updateCanvasDisplay();
  }

  function loadImageFromFile(file) {
    return new Promise((resolve, reject) => {
      const reader = new FileReader();
      reader.onload = e => {
        const img = new Image();
        img.onload = () => resolve(img);
        img.onerror = reject;
        img.src = e.target.result;
      };
      reader.onerror = reject;
      reader.readAsDataURL(file);
    });
  }

  // æ‹–æ‹½ä¸Šä¼ æ”¯æŒ
  const uploadZone = document.querySelector('.upload-zone');
  
  ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, preventDefaults, false);
  });

  function preventDefaults(e) {
    e.preventDefault();
    e.stopPropagation();
  }

  ['dragenter', 'dragover'].forEach(eventName => {
    uploadZone.addEventListener(eventName, () => {
      uploadZone.classList.add('drag-over');
    }, false);
  });

  ['dragleave', 'drop'].forEach(eventName => {
    uploadZone.addEventListener(eventName, () => {
      uploadZone.classList.remove('drag-over');
    }, false);
  });

  uploadZone.addEventListener('drop', handleDrop, false);

  function handleDrop(e) {
    const dt = e.dataTransfer;
    const files = dt.files;
    if (files.length > 0) {
      fileInput.files = files;
      fileInput.dispatchEvent(new Event('change', { bubbles: true }));
    }
  }

  fileInput.addEventListener('change', async (e) => {
    const file = e.target.files[0];
    if (!file) return;

    if (!file.type.startsWith('image/')) {
      showToast('è¯·ä¸Šä¼ å›¾ç‰‡æ–‡ä»¶', 'error');
      return;
    }

    setStatus('æ­£åœ¨åŠ è½½å›¾ç‰‡...', '');
    setBadge('åŠ è½½å›¾ç‰‡ä¸­');
    resetResult();

    try {
      const img = await loadImageFromFile(file);
      originalImage = img;
      imageBlob = file;
      boxes = [];
      history = [[]];
      historyIndex = 0;
      tempBox = null;
      selectedBoxIndex = -1;
      zoom = 1.0;
      canvasWrapper.style.display = 'block';
      
      // ç­‰å¾…DOMæ›´æ–°åå†ç»˜åˆ¶å’Œé€‚åº”çª—å£
      requestAnimationFrame(() => {
        drawImageAndBoxes();
        // è‡ªåŠ¨é€‚åº”çª—å£
        zoomToFit();
      });
      
      runBtn.disabled = false;
      clearBtn.disabled = false;
      clearImageBtn.disabled = false;
      updateUndoRedoButtons();
      updateBoxList();
      updateStats();
      setStatus('å›¾ç‰‡å·²åŠ è½½ï¼ŒæŒ‰ä½å·¦é”®æ‹–åŠ¨è¿›è¡Œæ¡†é€‰ï¼ˆæ°´å°åŒºåŸŸå¯å¤šé€‰ï¼‰ã€‚', 'success');
      setBadge('å·²åŠ è½½å›¾ç‰‡ï¼Œç­‰å¾…æ¡†é€‰');
      showToast('å›¾ç‰‡åŠ è½½æˆåŠŸ', 'success');
    } catch (err) {
      console.error(err);
      setStatus('å›¾ç‰‡åŠ è½½å¤±è´¥ï¼Œè¯·é‡è¯•ã€‚', 'error');
      setBadge('åŠ è½½å¤±è´¥');
      showToast('å›¾ç‰‡åŠ è½½å¤±è´¥', 'error');
    }
  });

  canvas.addEventListener('mousedown', (e) => {
    if (!originalImage) return;
    selectedBoxIndex = -1;
    
    // æ£€æŸ¥æ˜¯å¦ç‚¹å‡»åœ¨å·²æœ‰æ¡†å†…
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const clickX = (e.clientX - rect.left) * scaleX;
    const clickY = (e.clientY - rect.top) * scaleY;
    
    for (let i = boxes.length - 1; i >= 0; i--) {
      const [x1, y1, x2, y2] = boxes[i];
      if (clickX >= x1 && clickX <= x2 && clickY >= y1 && clickY <= y2) {
        selectedBoxIndex = i;
        drawImageAndBoxes();
        return;
      }
    }
    
    isDrawing = true;
    startX = clickX;
    startY = clickY;
    tempBox = [startX, startY, startX, startY];
    drawImageAndBoxes();
  });

  canvas.addEventListener('mousemove', (e) => {
    if (!originalImage) return;
    if (!isDrawing) {
      // æ›´æ–°é¼ æ ‡æ ·å¼
      const rect = canvas.getBoundingClientRect();
      const scaleX = canvas.width / rect.width;
      const scaleY = canvas.height / rect.height;
      const mouseX = (e.clientX - rect.left) * scaleX;
      const mouseY = (e.clientY - rect.top) * scaleY;
      
      let overBox = false;
      for (const [x1, y1, x2, y2] of boxes) {
        if (mouseX >= x1 && mouseX <= x2 && mouseY >= y1 && mouseY <= y2) {
          overBox = true;
          break;
        }
      }
      canvas.style.cursor = overBox ? 'pointer' : 'crosshair';
      return;
    }
    
    const rect = canvas.getBoundingClientRect();
    const scaleX = canvas.width / rect.width;
    const scaleY = canvas.height / rect.height;
    const currentX = (e.clientX - rect.left) * scaleX;
    const currentY = (e.clientY - rect.top) * scaleY;
    tempBox = [
      Math.min(startX, currentX),
      Math.min(startY, currentY),
      Math.max(startX, currentX),
      Math.max(startY, currentY),
    ];
    drawImageAndBoxes();
  });

  function finishDrawing() {
    if (!isDrawing || !tempBox) return;
    isDrawing = false;
    const [x1, y1, x2, y2] = tempBox;
    // è¿‡æ»¤æ‰å¤ªå°çš„æ¡†
    if (Math.abs(x2 - x1) > 4 && Math.abs(y2 - y1) > 4) {
      boxes.push([x1, y1, x2, y2]);
      saveHistory();
      updateBoxList();
      updateStats();
      setStatus(`å·²æ·»åŠ çŸ©å½¢æ¡†ï¼Œå½“å‰å…± ${boxes.length} ä¸ªã€‚`, 'success');
      setBadge(`å·²é€‰æ‹© ${boxes.length} ä¸ªåŒºåŸŸ`);
      showToast(`å·²æ·»åŠ åŒºåŸŸ ${boxes.length}`, 'success');
    } else {
      setStatus('çŸ©å½¢å¤ªå°ï¼Œå·²è‡ªåŠ¨å¿½ç•¥ã€‚', 'error');
    }
    tempBox = null;
    selectedBoxIndex = -1;
    drawImageAndBoxes();
  }

  canvas.addEventListener('mouseup', finishDrawing);
  canvas.addEventListener('mouseleave', () => {
    if (!isDrawing) return;
    finishDrawing();
  });

  canvas.addEventListener('contextmenu', (e) => {
    e.preventDefault();
    if (isDrawing) {
      isDrawing = false;
      tempBox = null;
      drawImageAndBoxes();
      setStatus('å·²å–æ¶ˆå½“å‰æ¡†é€‰ã€‚', '');
    }
  });

  canvas.addEventListener('dblclick', () => {
    if (isDrawing) {
      isDrawing = false;
      tempBox = null;
      drawImageAndBoxes();
      setStatus('å·²å–æ¶ˆå½“å‰æ¡†é€‰ã€‚', '');
    }
  });

  clearBtn.addEventListener('click', () => {
    if (boxes.length === 0) return;
    boxes = [];
    saveHistory();
    tempBox = null;
    selectedBoxIndex = -1;
    drawImageAndBoxes();
    updateBoxList();
    updateStats();
    setStatus('å·²æ¸…ç©ºæ‰€æœ‰çŸ©å½¢æ¡†ã€‚', '');
    setBadge('ç­‰å¾…æ¡†é€‰');
    showToast('å·²æ¸…ç©ºæ‰€æœ‰åŒºåŸŸ', 'success');
  });

  // æ¸…é™¤å›¾ç‰‡æŒ‰é’®
  clearImageBtn.addEventListener('click', () => {
    if (!originalImage) return;
    if (confirm('ç¡®å®šè¦æ¸…é™¤å½“å‰å›¾ç‰‡å’Œæ‰€æœ‰æ“ä½œå—ï¼Ÿ')) {
      clearAll();
    }
  });

  // é”®ç›˜å¿«æ·é”®
  document.addEventListener('keydown', (e) => {
    if (e.ctrlKey || e.metaKey) {
      if (e.key === 'z' && !e.shiftKey) {
        e.preventDefault();
        undo();
      } else if ((e.key === 'y') || (e.key === 'z' && e.shiftKey)) {
        e.preventDefault();
        redo();
      }
    } else if (e.key === 'Delete' || e.key === 'Backspace') {
      if (selectedBoxIndex >= 0 && selectedBoxIndex < boxes.length) {
        boxes.splice(selectedBoxIndex, 1);
        saveHistory();
        selectedBoxIndex = -1;
        drawImageAndBoxes();
        updateBoxList();
        updateStats();
        showToast('å·²åˆ é™¤é€‰ä¸­åŒºåŸŸ', 'success');
      }
    }
  });

  // ç¼©æ”¾æ§åˆ¶
  zoomInBtn.addEventListener('click', zoomIn);
  zoomOutBtn.addEventListener('click', zoomOut);
  zoomFitBtn.addEventListener('click', zoomToFit);

  // é¼ æ ‡æ»šè½®ç¼©æ”¾
  canvasContainer.addEventListener('wheel', (e) => {
    if (e.ctrlKey || e.metaKey) {
      e.preventDefault();
      const delta = e.deltaY > 0 ? 0.9 : 1.1;
      setZoom(zoom * delta);
    }
  }, { passive: false });

  // æ’¤é”€/é‡åšæŒ‰é’®
  undoBtn.addEventListener('click', undo);
  redoBtn.addEventListener('click', redo);

  // ä¸‹è½½æŒ‰é’®äº‹ä»¶ï¼ˆåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šï¼‰
  downloadBtn.addEventListener('click', () => {
    if (resultImageUrl) {
      const a = document.createElement('a');
      a.href = resultImageUrl;
      a.download = `inpainted_${Date.now()}.png`;
      a.click();
      showToast('å¼€å§‹ä¸‹è½½', 'success');
    } else {
      showToast('æ²¡æœ‰å¯ä¸‹è½½çš„å›¾ç‰‡', 'error');
    }
  });

  // å…¨å±æŸ¥çœ‹æŒ‰é’®äº‹ä»¶ï¼ˆåœ¨åˆå§‹åŒ–æ—¶ç»‘å®šï¼‰
  fullscreenBtn.addEventListener('click', () => {
    if (overlayImg.src && overlayImg.complete) {
      resultOverlay.classList.add('active');
      document.body.style.overflow = 'hidden'; // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
    } else if (resultImageUrl) {
      overlayImg.src = resultImageUrl;
      overlayImg.onload = () => {
        resultOverlay.classList.add('active');
        document.body.style.overflow = 'hidden';
      };
    } else {
      showToast('æ²¡æœ‰å¯æŸ¥çœ‹çš„å›¾ç‰‡', 'error');
    }
  });

  // å…¨å±æŸ¥çœ‹å…³é—­äº‹ä»¶ï¼ˆç‚¹å‡»é®ç½©å…³é—­ï¼Œç‚¹å‡»å›¾ç‰‡ä¸å…³é—­ï¼‰
  resultOverlay.addEventListener('click', (e) => {
    if (e.target === resultOverlay) {
      resultOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  });
  
  // ç‚¹å‡»å›¾ç‰‡ä¸å…³é—­
  overlayImg.addEventListener('click', (e) => {
    e.stopPropagation();
  });

  // ESCé”®å…³é—­å…¨å±
  document.addEventListener('keydown', (e) => {
    if (e.key === 'Escape' && resultOverlay.classList.contains('active')) {
      resultOverlay.classList.remove('active');
      document.body.style.overflow = '';
    }
  });

  runBtn.addEventListener('click', async () => {
    if (!imageBlob) {
      setStatus('è¯·å…ˆä¸Šä¼ å›¾ç‰‡ã€‚', 'error');
      showToast('è¯·å…ˆä¸Šä¼ å›¾ç‰‡', 'error');
      return;
    }
    if (!boxes.length) {
      setStatus('è¯·è‡³å°‘æ¡†é€‰ä¸€ä¸ªæ°´å°åŒºåŸŸå†å¼€å§‹ã€‚', 'error');
      showToast('è¯·è‡³å°‘æ¡†é€‰ä¸€ä¸ªåŒºåŸŸ', 'error');
      return;
    }

    runBtn.disabled = true;
    clearBtn.disabled = true;
    clearImageBtn.disabled = true;
    runBtnText.textContent = 'å¤„ç†ä¸­...';
    runBtnSpinner.style.display = 'inline-block';
    progressBar.classList.add('active');
    progressFill.style.width = '30%';
    setStatus('æ­£åœ¨è°ƒç”¨ AI å»æ°´å°ï¼Œè¿™å¯èƒ½éœ€è¦å‡ ç§’é’Ÿ...', '');
    setBadge('æ¨¡å‹æ¨ç†ä¸­...');

    try {
      const formData = new FormData();
      formData.append('file', imageBlob);
      formData.append('boxes', JSON.stringify(boxes));

      progressFill.style.width = '60%';

      const resp = await fetch('/api/remove_watermark', {
        method: 'POST',
        body: formData,
      });

      progressFill.style.width = '90%';

      if (!resp.ok) {
        const errorText = await resp.text();
        throw new Error(errorText || 'æœåŠ¡è°ƒç”¨å¤±è´¥');
      }

      const blob = await resp.blob();
      progressFill.style.width = '100%';
      
      // é‡Šæ”¾ä¹‹å‰çš„URL
      if (resultImageUrl) {
        URL.revokeObjectURL(resultImageUrl);
      }
      
      const url = URL.createObjectURL(blob);
      resultImageUrl = url;
      resultImg.src = url;
      resultImg.style.display = 'block';
      placeholder.style.display = 'none';
      downloadBtn.disabled = false;
      fullscreenBtn.disabled = false;
      
      // ç¡®ä¿overlayImgæ­£ç¡®åŠ è½½
      overlayImg.onload = () => {
        overlayImg.onload = null;
      };
      overlayImg.onerror = () => {
        console.error('Failed to load overlay image');
        overlayImg.onerror = null;
      };
      overlayImg.src = url;

      setTimeout(() => {
        progressBar.classList.remove('active');
        progressFill.style.width = '0%';
      }, 500);

      setStatus('å»æ°´å°å®Œæˆï¼Œå¦‚æœ‰éœ€è¦å¯è°ƒæ•´æ¡†é€‰åŒºåŸŸåå†æ¬¡å¤„ç†ã€‚', 'success');
      setBadge('å»æ°´å°å®Œæˆ');
      showToast('å»æ°´å°å®Œæˆï¼', 'success');
    } catch (err) {
      console.error(err);
      setStatus('å»æ°´å°å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æ˜¯å¦å·²å¯åŠ¨ï¼Œæˆ–ç¨åé‡è¯•ã€‚', 'error');
      setBadge('å¤„ç†å¤±è´¥');
      showToast('å¤„ç†å¤±è´¥ï¼š' + (err.message || 'æœªçŸ¥é”™è¯¯'), 'error');
      progressBar.classList.remove('active');
      progressFill.style.width = '0%';
    } finally {
      runBtn.disabled = false;
      clearBtn.disabled = false;
      if (originalImage) {
        clearImageBtn.disabled = false;
      }
      runBtnText.textContent = 'ğŸš€ å¼€å§‹å»æ°´å°';
      runBtnSpinner.style.display = 'none';
    }
  });

  // å¯¹æ¯”åŸå›¾åŠŸèƒ½
  compareToggle.addEventListener('change', (e) => {
    if (e.target.checked && originalImage && resultImageUrl) {
      // ä¿å­˜å½“å‰ç»“æœå›¾URL
      if (!resultImg.dataset.originalSrc) {
        resultImg.dataset.originalSrc = resultImg.src;
      }
      resultImg.src = originalImage.src;
      showToast('æ˜¾ç¤ºåŸå›¾', 'info');
    } else if (resultImageUrl && !e.target.checked) {
      // æ¢å¤æ˜¾ç¤ºç»“æœå›¾
      resultImg.src = resultImageUrl;
      showToast('æ˜¾ç¤ºç»“æœ', 'info');
    }
  });
</script>
</body>
</html>



